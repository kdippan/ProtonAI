<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Professional Chatbot</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/marked/marked.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" src="app.js"></script>
    <style type="text/css" media="all">
   /* Enhanced styles with ProtonAI-like design */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: grey;
    min-height: 100vh;
    overflow-x: hidden;
}

@keyframes gradient-shift {
    0%, 100% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
}

.glass-effect {
    backdrop-filter: blur(16px) saturate(180%);
    background-color: rgba(255, 255, 255, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.125);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.dark .glass-effect {
    background-color: rgba(17, 25, 40, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.125);
}

/* Navigation Bar */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 1rem 2rem;
}

.dark .navbar {
    background: rgba(17, 25, 40, 0.9);
}

.navbar-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.navbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.navbar-stats {
    display: flex;
    gap: 20px;
    align-items: center;
    font-size: 0.875rem;
    color: #6b7280;
}

.dark .navbar-stats {
    color: #9ca3af;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.dark .stat-item {
    background: rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.1);
}

/* Chat Tabs */
.chat-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding: 4px;
}

.chat-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    min-width: 120px;
    font-size: 0.875rem;
}

.chat-tab:hover {
    background: rgba(255, 255, 255, 0.8);
    transform: translateY(-1px);
}

.chat-tab.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: transparent;
}

.dark .chat-tab {
    background: rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e5e7eb;
}

.dark .chat-tab:hover {
    background: rgba(0, 0, 0, 0.5);
}

.tab-close {
    padding: 2px;
    border-radius: 50%;
    transition: background 0.2s ease;
}

.tab-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Message Bubbles with ProtonAI styling */
.message-bubble {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    border-radius: 16px;
    margin-bottom: 16px;
}

.message-bubble:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.message-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.message-bubble:hover .message-actions {
    opacity: 1;
}

.action-btn {
    padding: 6px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 12px;
    color: #6b7280;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 1);
    color: #374151;
    transform: scale(1.1);
}

.dark .action-btn {
    background: rgba(0, 0, 0, 0.7);
    color: #9ca3af;
}

.dark .action-btn:hover {
    background: rgba(0, 0, 0, 0.9);
    color: #e5e7eb;
}

/* ProtonAI-style Code Formatting */
.message-content {
    line-height: 1.6;
    font-size: 15px;
}

.message-content pre {
    background: #1e1e1e;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    overflow-x: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    position: relative;
}

.message-content pre::before {
    content: attr(data-language);
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 11px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.message-content code {
    background: rgba(0, 0, 0, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9em;
    color: #e11d48;
}

.message-content pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    color: #f8f8f2;
}

.message-content strong {
    font-weight: 600;
    color: inherit;
}

.message-content em {
    font-style: italic;
    color: #7c3aed;
}

.message-content u {
    text-decoration: underline;
    text-decoration-color: #06b6d4;
}

.message-content blockquote {
    border-left: 4px solid #667eea;
    padding-left: 16px;
    margin: 12px 0;
    font-style: italic;
    background: rgba(102, 126, 234, 0.05);
    padding: 12px 16px;
    border-radius: 8px;
}

.message-content ul, .message-content ol {
    padding-left: 24px;
    margin: 12px 0;
}

.message-content li {
    margin: 4px 0;
}

.message-content h1, .message-content h2, .message-content h3 {
    margin: 16px 0 8px 0;
    font-weight: 600;
    color: #1f2937;
}

.dark .message-content h1,
.dark .message-content h2,
.dark .message-content h3 {
    color: #f9fafb;
}

/* Copy notification */
.copy-notification {
    position: fixed;
    top: 100px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1001;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Edit Modal */
.edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1002;
}

.edit-modal-content {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.dark .edit-modal-content {
    background: #1f2937;
    color: white;
}

.edit-textarea {
    width: 100%;
    min-height: 200px;
    padding: 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
    margin-bottom: 16px;
}

.dark .edit-textarea {
    background: #374151;
    border-color: #4b5563;
    color: white;
}

/* Typing indicator */
.typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: currentColor;
    opacity: 0.4;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.typing-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typing {
    0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(1);
    }
    40% {
        opacity: 1;
        transform: scale(1.2);
    }
}

/* Responsive design */
@media (max-width: 768px) {
    .navbar {
        padding: 1rem;
    }
    
    .navbar-stats {
        display: none;
    }
    
    .chat-tabs {
        margin-bottom: 16px;
    }
    
    .message-actions {
        opacity: 1;
        position: relative;
        top: auto;
        right: auto;
        margin-top: 8px;
        justify-content: flex-end;
    }
}

/* Button styles */
.btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: inherit;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

/* Input styles */
.input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(8px);
}

.input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.dark .input {
    background: rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.1);
    color: white;
}

.dark .input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

/* Modal styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    width: 90%;
}

.dark .modal-content {
    background: #1f2937;
    color: white;
}

/* Scrollbar styling */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(156, 163, 175, 0.8);
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
     
    </style>
    <script>
        const { useState, useEffect, useRef } = React;
const { motion, AnimatePresence } = Motion;

const OPENROUTER_API_KEY = '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';
const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';

// Utility functions
const generateChatId = () => {
    return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
};

const formatMessage = (content) => {
    // Enhanced formatting with ProtonAI-style code blocks
    let formatted = content
        // Code blocks with language detection
        .replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
            const language = lang || 'text';
            return `<pre data-language="${language}"><code class="language-${language}">${code.trim()}</code></pre>`;
        })
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Underline
        .replace(/__(.*?)__/g, '<u>$1</u>')
        // Inline code
        .replace(/`(.*?)`/g, '<code>$1</code>')
        // Blockquotes
        .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
        // Headers
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        // Lists
        .replace(/^\* (.*$)/gm, '<li>$1</li>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        // Line breaks
        .replace(/\n/g, '<br>');
    
    // Wrap consecutive list items in ul tags
    formatted = formatted.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
    
    return formatted;
};

const saveToLocalStorage = (key, data) => {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
        console.error('Error saving to localStorage:', error);
    }
};

const loadFromLocalStorage = (key) => {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (error) {
        console.error('Error loading from localStorage:', error);
        return null;
    }
};

// Token estimation function
const estimateTokens = (text) => {
    // Rough estimation: 1 token ≈ 4 characters
    return Math.ceil(text.length / 4);
};

// Navigation Bar Component
const NavigationBar = ({ userName, totalTokens, totalChats, isDarkMode, onToggleDarkMode }) => {
    return (
        <div className="navbar">
            <div className="navbar-content">
                <div className="navbar-brand">
                    <i className="fas fa-robot"></i>
                    AI Assistant
                </div>
                <div className="navbar-stats">
                    <div className="stat-item">
                        <i className="fas fa-user"></i>
                        {userName}
                    </div>
                    <div className="stat-item">
                        <i className="fas fa-comments"></i>
                        {totalChats} Chats
                    </div>
                    <div className="stat-item">
                        <i className="fas fa-coins"></i>
                        {totalTokens.toLocaleString()} Tokens
                    </div>
                    <button
                        onClick={onToggleDarkMode}
                        className="btn btn-secondary"
                        style={{ padding: '6px 12px' }}
                    >
                        <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                    </button>
                </div>
            </div>
        </div>
    );
};

// Chat Tabs Component
const ChatTabs = ({ chats, activeChat, onSelectChat, onCloseChat, onNewChat }) => {
    return (
        <div className="chat-tabs">
            {chats.map((chat) => (
                <div
                    key={chat.id}
                    className={`chat-tab ${activeChat === chat.id ? 'active' : ''}`}
                    onClick={() => onSelectChat(chat.id)}
                >
                    <span>{chat.title}</span>
                    {chats.length > 1 && (
                        <button
                            className="tab-close"
                            onClick={(e) => {
                                e.stopPropagation();
                                onCloseChat(chat.id);
                            }}
                        >
                            <i className="fas fa-times" style={{ fontSize: '10px' }}></i>
                        </button>
                    )}
                </div>
            ))}
            <button
                className="chat-tab"
                onClick={onNewChat}
                style={{ background: 'rgba(102, 126, 234, 0.1)', border: '2px dashed rgba(102, 126, 234, 0.3)' }}
            >
                <i className="fas fa-plus"></i>
                New Chat
            </button>
        </div>
    );
};

// Copy Notification Component
const CopyNotification = ({ show, message }) => {
    if (!show) return null;
    
    return (
        <div className="copy-notification">
            <i className="fas fa-check"></i>
            {message}
        </div>
    );
};

// Edit Modal Component
const EditModal = ({ isOpen, content, onSave, onClose }) => {
    const [editedContent, setEditedContent] = useState(content);
    
    useEffect(() => {
        setEditedContent(content);
    }, [content]);
    
    if (!isOpen) return null;
    
    return (
        <div className="edit-modal" onClick={onClose}>
            <div className="edit-modal-content" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-semibold mb-4">Edit Message</h3>
                <textarea
                    className="edit-textarea"
                    value={editedContent}
                    onChange={(e) => setEditedContent(e.target.value)}
                    placeholder="Edit your message..."
                />
                <div className="flex gap-2 justify-end">
                    <button className="btn btn-secondary" onClick={onClose}>
                        Cancel
                    </button>
                    <button 
                        className="btn btn-primary" 
                        onClick={() => onSave(editedContent)}
                    >
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    );
};

// Welcome Modal Component
const WelcomeModal = ({ isOpen, onClose, onSubmit }) => {
    const [name, setName] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (name.trim()) {
            onSubmit(name.trim());
            onClose();
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <motion.div
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                className="modal-content"
            >
                <h2 className="text-2xl font-bold mb-4 text-center">Welcome to AI Assistant!</h2>
                <p className="text-gray-600 mb-6 text-center">Please enter your name to get started</p>
                <form onSubmit={handleSubmit}>
                    <input
                        type="text"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        placeholder="Enter your name..."
                        className="input mb-4"
                        autoFocus
                        required
                    />
                    <button type="submit" className="btn btn-primary w-full">
                        Start Chatting
                    </button>
                </form>
            </motion.div>
        </div>
    );
};

// Share Modal Component
const ShareModal = ({ isOpen, onClose, chatId }) => {
    const [copied, setCopied] = useState(false);
    const shareUrl = `${window.location.origin}?chat=${chatId}`;

    const copyToClipboard = async () => {
        try {
            await navigator.clipboard.writeText(shareUrl);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        } catch (error) {
            console.error('Failed to copy:', error);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay" onClick={onClose}>
            <motion.div
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                className="modal-content"
                onClick={(e) => e.stopPropagation()}
            >
                <h2 className="text-xl font-bold mb-4">Share Chat</h2>
                <p className="text-gray-600 mb-4">Share this conversation with others:</p>
                <div className="flex gap-2 mb-4">
                    <input
                        type="text"
                        value={shareUrl}
                        readOnly
                        className="input flex-1"
                    />
                    <button
                        onClick={copyToClipboard}
                        className="btn btn-primary"
                    >
                        {copied ? 'Copied!' : 'Copy'}
                    </button>
                </div>
                <button onClick={onClose} className="btn btn-secondary w-full">
                    Close
                </button>
            </motion.div>
        </div>
    );
};

// Main App Component
const App = () => {
    const [chats, setChats] = useState([]);
    const [activeChat, setActiveChat] = useState('');
    const [messages, setMessages] = useState([]);
    const [inputMessage, setInputMessage] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [userName, setUserName] = useState('');
    const [showWelcomeModal, setShowWelcomeModal] = useState(true);
    const [showShareModal, setShowShareModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [editingMessage, setEditingMessage] = useState(null);
    const [copyNotification, setCopyNotification] = useState({ show: false, message: '' });
    const [totalTokens, setTotalTokens] = useState(0);
    const messagesEndRef = useRef(null);
    const inputRef = useRef(null);

    // Initialize app
    useEffect(() => {
        // Check for shared chat in URL
        const urlParams = new URLSearchParams(window.location.search);
        const sharedChatId = urlParams.get('chat');
        
        if (sharedChatId) {
            const sharedChat = loadFromLocalStorage(`chat_${sharedChatId}`);
            if (sharedChat) {
                setMessages(sharedChat.messages);
                setUserName(sharedChat.userName);
                setActiveChat(sharedChatId);
                setChats([{ id: sharedChatId, title: sharedChat.title || 'Shared Chat' }]);
                setShowWelcomeModal(false);
                return;
            }
        }

        // Load existing user data
        const savedUserName = loadFromLocalStorage('userName');
        const savedChats = loadFromLocalStorage('userChats') || [];
        const savedTotalTokens = loadFromLocalStorage('totalTokens') || 0;
        
        setTotalTokens(savedTotalTokens);
        
        if (savedUserName && savedChats.length > 0) {
            setUserName(savedUserName);
            setChats(savedChats);
            
            // Always start with a new chat on reload/revisit
            const newChatId = generateChatId();
            const newChat = {
                id: newChatId,
                title: `Chat ${savedChats.length + 1}`,
                messages: [{
                    id: 1,
                    role: 'assistant',
                    content: `Welcome back, ${savedUserName}! I'm your AI assistant. How can I help you today?`,
                    timestamp: new Date()
                }]
            };
            
            setActiveChat(newChatId);
            setMessages(newChat.messages);
            setChats(prev => [...prev, newChat]);
            setShowWelcomeModal(false);
        }
    }, []);

    // Auto-scroll to bottom
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    // Dark mode effect
    useEffect(() => {
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }, [isDarkMode]);

    // Save chat data
    useEffect(() => {
        if (activeChat && messages.length > 0) {
            const chatData = {
                messages,
                userName,
                title: chats.find(c => c.id === activeChat)?.title || 'New Chat',
                lastUpdated: new Date().toISOString()
            };
            saveToLocalStorage(`chat_${activeChat}`, chatData);
            
            // Update chats list
            const updatedChats = chats.map(chat => 
                chat.id === activeChat 
                    ? { ...chat, lastUpdated: new Date().toISOString() }
                    : chat
            );
            setChats(updatedChats);
            saveToLocalStorage('userChats', updatedChats);
        }
    }, [messages, activeChat, chats, userName]);

    // Save total tokens
    useEffect(() => {
        saveToLocalStorage('totalTokens', totalTokens);
    }, [totalTokens]);

    const handleWelcomeSubmit = (name) => {
        setUserName(name);
        saveToLocalStorage('userName', name);
        
        const newChatId = generateChatId();
        const newChat = {
            id: newChatId,
            title: 'Chat 1',
            lastUpdated: new Date().toISOString()
        };
        
        setActiveChat(newChatId);
        setChats([newChat]);
        saveToLocalStorage('userChats', [newChat]);
        
        const welcomeMessage = {
            id: 1,
            role: 'assistant',
            content: `Hello ${name}! I'm your AI assistant. How can I help you today?`,
            timestamp: new Date()
        };
        setMessages([welcomeMessage]);
    };

    const sendMessage = async (messageContent = null) => {
        const content = messageContent || inputMessage.trim();
        if (!content || isLoading) return;

        const userMessage = {
            id: Date.now(),
            role: 'user',
            content: content,
            timestamp: new Date()
        };

        setMessages(prev => [...prev, userMessage]);
        if (!messageContent) setInputMessage('');
        setIsLoading(true);

        // Calculate tokens for user message
        const userTokens = estimateTokens(content);
        setTotalTokens(prev => prev + userTokens);

        try {
            const conversationHistory = messages.map(msg => ({
                role: msg.role,
                content: msg.content
            }));
            
            conversationHistory.push({
                role: 'user',
                content: content
            });

            const response = await fetch(OPENROUTER_API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'AI Assistant Chatbot'
                },
                
                    messages: conversationHistory,
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            const assistantContent = data.choices[0].message.content;
            const assistantMessage = {
                id: Date.now() + 1,
                role: 'assistant',
                content: assistantContent,
                timestamp: new Date()
            };

            // Calculate tokens for assistant message
            const assistantTokens = estimateTokens(assistantContent);
            setTotalTokens(prev => prev + assistantTokens);

            setMessages(prev => [...prev, assistantMessage]);
        } catch (error) {
            console.error('Error sending message:', error);
            const errorMessage = {
                id: Date.now() + 1,
                role: 'assistant',
                content: 'I apologize, but I encountered an error while processing your request. Please try again.',
                timestamp: new Date()
            };
            setMessages(prev => [...prev, errorMessage]);
        } finally {
            setIsLoading(false);
            inputRef.current?.focus();
        }
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    const formatTime = (timestamp) => {
        return timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    };

    const copyMessage = async (content) => {
        try {
            await navigator.clipboard.writeText(content);
            setCopyNotification({ show: true, message: 'Message copied to clipboard!' });
            setTimeout(() => setCopyNotification({ show: false, message: '' }), 3000);
        } catch (err) {
            console.error('Failed to copy message:', err);
        }
    };

    const editMessage = (message) => {
        setEditingMessage(message);
        setShowEditModal(true);
    };

    const saveEditedMessage = (newContent) => {
        if (editingMessage && newContent.trim()) {
            // Remove all messages after the edited message
            const messageIndex = messages.findIndex(m => m.id === editingMessage.id);
            const updatedMessages = messages.slice(0, messageIndex);
            setMessages(updatedMessages);
            
            // Send the edited message
            sendMessage(newContent.trim());
        }
        setShowEditModal(false);
        setEditingMessage(null);
    };

    const selectChat = (chatId) => {
        setActiveChat(chatId);
        const chatData = loadFromLocalStorage(`chat_${chatId}`);
        if (chatData) {
            setMessages(chatData.messages);
        }
    };

    const closeChat = (chatId) => {
        const updatedChats = chats.filter(chat => chat.id !== chatId);
        setChats(updatedChats);
        saveToLocalStorage('userChats', updatedChats);
        
        if (activeChat === chatId) {
            if (updatedChats.length > 0) {
                selectChat(updatedChats[0].id);
            } else {
                createNewChat();
            }
        }
    };

    const createNewChat = () => {
        const newChatId = generateChatId();
        const newChat = {
            id: newChatId,
            title: `Chat ${chats.length + 1}`,
            lastUpdated: new Date().toISOString()
        };
        
        setActiveChat(newChatId);
        setChats(prev => [...prev, newChat]);
        
        const welcomeMessage = {
            id: 1,
            role: 'assistant',
            content: `Hello ${userName}! I'm your AI assistant. How can I help you today?`,
            timestamp: new Date()
        };
        setMessages([welcomeMessage]);
    };

    return (
        <div className={`min-h-screen ${isDarkMode ? 'dark' : ''}`}>
            <NavigationBar
                userName={userName}
                totalTokens={totalTokens}
                totalChats={chats.length}
                isDarkMode={isDarkMode}
                onToggleDarkMode={() => setIsDarkMode(!isDarkMode)}
            />
            
            <div className="pt-20 p-4">
                <div className="max-w-6xl mx-auto h-screen flex flex-col">
                    {/* Chat Tabs */}
                    {chats.length > 0 && (
                        <ChatTabs
                            chats={chats}
                            activeChat={activeChat}
                            onSelectChat={selectChat}
                            onCloseChat={closeChat}
                            onNewChat={createNewChat}
                        />
                    )}

                    {/* Chat Messages */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        transition={{ duration: 0.6, delay: 0.1 }}
                        className="flex-1 mb-4"
                    >
                        <div className="glass-effect h-full p-4">
                            <div className="h-full overflow-y-auto custom-scrollbar">
                                <AnimatePresence>
                                    {messages.map((message, index) => (
                                        <motion.div
                                            key={message.id}
                                            initial={{ opacity: 0, y: 20 }}
                                            animate={{ opacity: 1, y: 0 }}
                                            exit={{ opacity: 0, y: -20 }}
                                            transition={{ duration: 0.4, delay: index * 0.05 }}
                                            className={`flex gap-3 mb-4 ${
                                                message.role === 'user' ? 'justify-end' : 'justify-start'
                                            }`}
                                        >
                                            {message.role === 'assistant' && (
                                                <div className="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                                    <i className="fas fa-robot text-white text-sm"></i>
                                                </div>
                                            )}
                                            
                                            <div
                                                className={`max-w-[70%] message-bubble relative ${
                                                    message.role === 'user'
                                                        ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white'
                                                        : 'bg-white/90 dark:bg-gray-700/90 text-gray-800 dark:text-gray-100'
                                                } px-4 py-3`}
                                            >
                                                {/* Message Actions */}
                                                <div className="message-actions">
                                                    <button
                                                        onClick={() => copyMessage(message.content)}
                                                        className="action-btn"
                                                        title="Copy message"
                                                    >
                                                        <i className="fas fa-copy"></i>
                                                    </button>
                                                    {message.role === 'user' && (
                                                        <button
                                                            onClick={() => editMessage(message)}
                                                            className="action-btn"
                                                            title="Edit message"
                                                        >
                                                            <i className="fas fa-edit"></i>
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                <div 
                                                    className="message-content"
                                                    dangerouslySetInnerHTML={{ 
                                                        __html: formatMessage(message.content) 
                                                    }}
                                                />
                                                <div className={`text-xs opacity-70 mt-2 ${
                                                    message.role === 'user' ? 'text-blue-100' : 'text-gray-500'
                                                }`}>
                                                    {formatTime(message.timestamp)}
                                                </div>
                                            </div>

                                            {message.role === 'user' && (
                                                <div className="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-gray-500 to-gray-600 rounded-full flex items-center justify-center">
                                                    <i className="fas fa-user text-white text-sm"></i>
                                                </div>
                                            )}
                                        </motion.div>
                                    ))}
                                </AnimatePresence>

                                {isLoading && (
                                    <motion.div
                                        initial={{ opacity: 0, y: 20 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        className="flex gap-3 mb-4"
                                    >
                                        <div className="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                            <i className="fas fa-robot text-white text-sm"></i>
                                        </div>
                                        <div className="bg-white/90 dark:bg-gray-700/90 rounded-2xl px-4 py-3">
                                            <div className="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                                                <div className="typing-indicator">
                                                    <div className="typing-dot"></div>
                                                    <div className="typing-dot"></div>
                                                    <div className="typing-dot"></div>
                                                </div>
                                                <span className="text-sm">Thinking...</span>
                                            </div>
                                        </div>
                                    </motion.div>
                                )}

                                <div ref={messagesEndRef} />
                            </div>
                        </div>
                    </motion.div>

                    {/* Input Area */}
                    <motion.div
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.6, delay: 0.2 }}
                    >
                        <div className="glass-effect p-4">
                            <div className="flex gap-3">
                                <input
                                    ref={inputRef}
                                    type="text"
                                    value={inputMessage}
                                    onChange={(e) => setInputMessage(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder="Type your message here..."
                                    disabled={isLoading}
                                    className="input flex-1"
                                />
                                <button
                                    onClick={() => sendMessage()}
                                    disabled={!inputMessage.trim() || isLoading}
                                    className="btn btn-primary"
                                >
                                    {isLoading ? (
                                        <i className="fas fa-spinner fa-spin"></i>
                                    ) : (
                                        <i className="fas fa-paper-plane"></i>
                                    )}
                                </button>
                                <button
                                    onClick={() => setShowShareModal(true)}
                                    className="btn btn-secondary"
                                >
                                    <i className="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </motion.div>
                </div>
            </div>

            {/* Modals and Notifications */}
            <WelcomeModal
                isOpen={showWelcomeModal}
                onClose={() => setShowWelcomeModal(false)}
                onSubmit={handleWelcomeSubmit}
            />
            
            <ShareModal
                isOpen={showShareModal}
                onClose={() => setShowShareModal(false)}
                chatId={activeChat}
            />
            
            <EditModal
                isOpen={showEditModal}
                content={editingMessage?.content || ''}
                onSave={saveEditedMessage}
                onClose={() => setShowEditModal(false)}
            />
            
            <CopyNotification
                show={copyNotification.show}
                message={copyNotification.message}
            />
        </div>
    );
};

// Render the app
ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
